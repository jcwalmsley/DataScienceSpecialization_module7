---
title: "Regression Models Project - Motor Trend Data 'mtcars' Miles Per Gallon Analysis"
author: "james c walmsley"
date: "12/1/2016"
output: 
  pdf_document: 
    fig_caption: yes
    fig_height: 5.5
---

#       Executive Summary:  
        The mean "MPG" rating of vehicles with automatic transmisions is 17.15 mpg, and those with manual transmisions 24.38 mpg for a difference of 7.24 mpg in favor of the manual transmission in the given data set.
        
        Upon further analysis of the relationship between vehicle design components and "MPG" ratings in this particular dat set we find that a small number of vehicles exhibit a degree of leverage and influence over the "MPG" analysis results at both ends of the ratings. The following vehicles!!!!!!!
        
        
        Additionally, vehicle weight is highly correlated (-86%) with mpg ratings and transmission type is highly correlated with vehicle wieght at (69%). In other words lighter vehicles tend to have manual transmissions where as heavier vehicles tend to have automatic trasnmissions. Figure XXX shows the analysis that explains this bias in the data and is confirmed in the QQ plots where the low and high "MPG" ratings are not inclusive of both types of transmissions. This figure also shows that where the cubic inch displacement and hp are generally equivalent between transmission types there is only a very slight difference in "MPG" rating. 
        
        To answer the question of whether automatic or manual transmissions are better for gas mileage we will look at vehicles with roughly the same design components  as possible using this given data set.  Such a comparison is best shown in figure XXXXX
        
        
#       Problem Statement & Questions to Answer:  
                ## Q1 “Is an automatic or manual transmission better for 'mpg'”  
                ## Q2 "Quantify the MPG difference between automatic and manual transmissions"  
---

#       Grading - Criteria (remove on completion)!!!  
        ####YES!!!! Did the report include an executive summary?
        ####???? Did the student answer the questions of interest or detail why the question(s) is (are) not answerable?
        ####???? Did the student quantify the uncertainty in their conclusions and/or perform an inference correctly?
        ####???? Was the report brief (about 2 pages long) for the main body of the report and no longer than 5 with supporting appendix of figures?


        ####YES!!!! Did the student interpret the coefficients correctly?
        ####YES!!!! Did the student do some exploratory data analyses?


        ####YES!!!! Did the student fit multiple models and detail their strategy for model selection?
        ####Needs some more work


        ####YES!!!! Did the student do a residual plot and some diagnostics?
        ####YES!!!! Was the report done in Rmd (knitr) with pdf output?

---

#       Analysis Considerations:
        Descriptive - (dim, mean, sd, sigma^2, str & summary) statistics
        
        Exploratory - pairs, histograms, QQ, fitted, residualplots, boxplots  
        & (multiple plots); T-Test
        
        Analysis -  OLS, simple linear regression, statistical linear regression,  
        multivariate regression & model selection, logistic regression, pValues,  
        adjustments, residuals, residual fit, predict fit, hatvalues, variance, & dfbetas, R^2,  
        diagnostics; ANOVA, coeficients, confint, correlation, covariance, variance inflation

#       Software Environment: &  System - session Info:
        Set the Working Directory then get System & Session Info
```{r SetDirectory, eval=FALSE, include=FALSE, results='hide'}
setwd("~/Desktop/Coursera_R/7_Regression Models/RM_proj_MPG_MotorTrendData")
sessionInfo()
```        
       
#       Accessing Data & Raw Data Overview: Motor Trend 'mtcars' data set:
        Clean up the work space & get the data: 
```{r Data_mtcars, include=FALSE, results='hide'}
rm(list=ls());library(car);library(dplyr); data("mtcars");any(is.na(mtcars));data(mtcars)
```
A data frame with 32 observations on 11 variables.  

[, 1]	mpg	Miles/(US) gallon  
[, 2]	cyl	Number of cylinders (4,6,8)
[, 3]	disp	Displacement (cu.in.)  
[, 4]	hp	Gross horsepower  
[, 5]	drat	Rear axle ratio  
[, 6]	wt	Weight (1000 lbs)  
[, 7]	qsec	1/4 mile time  
[, 8]	vs	V/S (V = vee-block, S = straight-block)
[, 9]	am	Transmission (0 = automatic, 1 = manual)  
[,10]	gear	Number of forward gears (3,4,5)
[,11]	carb	Number of carburetors (1,2,3,4,6,8)

#       Process Data: factor columns 2 & 8:11 (cyl,vs,am,gear,carb)
In the step we order the data set on mpg from top to bottom with increasing mpg and and factor columns 2 & 8:11 and use this revised data set for most of the remaining analysis
```{r ProcessData, message=TRUE, cache=TRUE, warning=TRUE, include=FALSE, results='hide'}
data("mtcars");
for(i in c(2,8:11))mtcars[,i] <- as.factor(mtcars[,i])
str(mtcars);ordmtcars <<- mtcars[order(mtcars$mpg,decreasing = FALSE),]
data <- rbind(head(ordmtcars,3),tail(ordmtcars,3))
dataord <- ordmtcars[1:3,]
```

#       Descriptive Statistics
Here we do not use the ordered data set so that we can know the unigue values in the otherwise factored columns.
```{r DescriptiveStats, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
sapply(mtcars, mean);sapply(mtcars[,c(2,8:11)],unique)
```


#       Exploratory Analysis:  
        See figures 1:4 in Appendix A
        Add narrative here!!
        
################-----------------##################
        
#       Statistical Modeling, Regression & Model Fit:
        Assumptions:
                A A correlation to mpg ratings may exist among multiple variables
                B
##      Simple Linear Regression Plot
In this plot we examine the relationship between mpg ratings and vehicle weight and find that as mpg rating increases vehicle weight decreases.
```{r Fig.4_SimpleLR, eval=FALSE, fig.height=3.5, fig.width=3.5, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
cor(ordmtcars$mpg, ordmtcars$wt);head(ordmtcars)
library(ggplot2); library(dplyr);library(ggplot2)
par(mfrow = c(2,1), mar = c(4,4,2,2)) # set margin
# f1 <- lm(mpg ~ I(factor(am)), data = ordmtcars)
# coef(summary(fit));
# g <- ggplot(ordmtcars, aes(x = factor(am), y = mpg),)
# g <- g + xlab("Transmission Type")
# g <- g + ylab("Miles per Gallon")
# g <- g + geom_point(size = 3.0, col = "purple", alpha = 0.55)
# g <- g + geom_abline(aes(intercept = 17, slope = 7))
# g
f2 <- lm(mpg ~ wt, data = ordmtcars)
coef(summary(f2))
g <- ggplot(ordmtcars, aes(x = wt, y = mpg),)
g <- g + xlab("Weight")
g <- g + ylab("Miles per Gallon")
g <- g + geom_point(size = 3.0, col = "purple", alpha = 0.55)
g <- g + geom_smooth(aes(method = "lm", se = FALSE))
g
```


##      Bivariate Linear Model: # Note: manual trans & eng shape / vs are significant
This plot examines adding to the weight component the transmision type in a bivariate model that highlights some vehicles with noticable leverage on the model results in particular the followign vehicles: for the low end of the mpg ratings ~ Chrysler Imperial, and for the high mpg ratings the ~ Fiat 128, Toyota Corolla, 
```{r Fig.5_BivariateLM, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
mvlmf <- lm(mpg ~ factor(am) + wt, data = ordmtcars)
coef(summary(mvlmf))
vif(mvlmf)
par(mfrow = c(2, 2), mar = c(4, 5, 2, 1))
plot(mvlmf)
```

##      Multivariate Linear Model (all vars)
Considering the results of the VIF (variance inflation test) vif(fit) results indicate variance inflation of these regressors: cyl, disp, hp, drat, wt, qsec, vs, am, gear, & carb. Considering the sqrt(vi(fit) though we can choose those regressors that have values less than three which are: drat, vs, gear, carb and keep the one of interest which is am
```{r Fig.6_MVLM(allvars), eval=FALSE, fig.height=4, fig.width=4, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
f1 <- lm(mpg ~ ., data = ordmtcars)
coef(summary(f1))
coef(summary(f1))
#                Estimate  Std. Error     t value   Pr(>|t|)
# (Intercept) 23.87913244 20.06582026  1.19004018 0.25252548
# cyl6        -2.64869528  3.04089041 -0.87102622 0.39746642
# cyl8        -0.33616298  7.15953951 -0.04695316 0.96317000
# disp         0.03554632  0.03189920  1.11433290 0.28267339
# hp          -0.07050683  0.03942556 -1.78835344 0.09393155
# drat         1.18283018  2.48348458  0.47627845 0.64073922
# wt          -4.52977584  2.53874584 -1.78425732 0.09461859
# qsec         0.36784482  0.93539569  0.39325050 0.69966720
# vs1          1.93085054  2.87125777  0.67247551 0.51150791
# am1          1.21211570  3.21354514  0.37718957 0.71131573
# gear4        1.11435494  3.79951726  0.29328856 0.77332027
# gear5        2.52839599  3.73635801  0.67670068 0.50889747
# carb2       -0.97935432  2.31797446 -0.42250436 0.67865093
# carb3        2.99963875  4.29354611  0.69863900 0.49546781
# carb4        1.09142288  4.44961992  0.24528452 0.80956031
# carb6        4.47756921  6.38406242  0.70136677 0.49381268
# carb8        7.25041126  8.36056638  0.86721532 0.39948495
# 
vif(f1)
#            GVIF Df GVIF^(1/(2*Df))
# cyl  128.120962  2        3.364380
# disp  60.365687  1        7.769536
# hp    28.219577  1        5.312210
# drat   6.809663  1        2.609533
# wt    23.830830  1        4.881683
# qsec  10.790189  1        3.284842
# vs     8.088166  1        2.843970
# am     9.930495  1        3.151269
# gear  50.852311  2        2.670408
# carb 503.211851  5        1.862838
#
sqrt(vif(f1))










# variables with low inflation variance =  drat,wt,qsec,vs & am; Therefore for the first model we will select these regressors
library(ggplot2);library(dplyr)
data <- ordmtcars
par(mfrow = c(1,1), mar = c(4,4,2,2)) # set margin
x <- as.numeric(unlist(data[,-1]))
y <- mpg
n <- length(y)
g <- ggplot(data, aes(x = data[,-1], y = y),)
g <- g + xlab("All Regressors")
g <- g + ylab("Miles per Gallon")
g <- g + geom_point(aes(size = 1.0, col = "blue", alpha = 0.55))
g <- g + geom_smooth(aes(method = "lm", col = "black"))
g

# g <- ggplot(ordmtcars, aes(x = drat, wt, qsec, vs, am, y = mpg),)
# g <- g + xlab("drat+wt+qsec+vs+am")
# g <- g + ylab("Miles per Gallon")
# g <- g + geom_point(size = 3.0, col = "blue", alpha = 0.55)
# g <- g + geom_smooth(method = "lm", col = "black")
# g
```
#       Note; vars with lowest vif = drat, vs & am




##      Multivariate Linear Model Adjusted 
```{r Fig.7_MVLM(allvars)A, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
f1 <- lm(mpg ~ . -1, data = ordmtcars)
coef(summary(f1))
confint(f1)
par(mfrow = c(1,1), mar = c(4,4,2,2)) # set margin
g <- ggplot(ordmtcars, aes(x = drat, wt, qsec, vs, am, -1, y = mpg),)
g <- g + xlab("Fit adjusted to the mean of (drat-wt-qsec-vs-am)")
g <- g + ylab("Miles per Gallon")
g <- g + geom_point(size = 3.0, col = "blue", alpha = 0.55)
g <- g + geom_smooth(aes(method = "lm", col = "black"))
g
```

##      Multivariate LM Nested & ANOVA table 
With nested modeling method, models 3 & 6 each add a significate variable to the fitted model and in this case model 3 is disp & model 6 is wt. Now use the vif (variable inflation) test on model six to check for any variance inflation among the varialbes of this model. The results show that "hp", "drat", and "wt" all have square rooted infaltion values less than 3.0 so these can be accepted into the model of best fit (fbf1) along with the main variable of the study "am"
```{r MVLM_ANOVA_table, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
fit <- lm(mpg ~ factor(am), data = ordmtcars)
fm2 <- update(fit, mpg ~ cyl)
fm3 <- update(fit, mpg ~ cyl + disp)
fm4 <- update(fit, mpg ~ cyl + disp + hp)
fm5 <- update(fit, mpg ~ cyl + disp + hp + drat)
fm6 <- update(fit, mpg ~ cyl + disp + hp + drat + wt)
fm7 <- update(fit, mpg ~ cyl + disp + hp + drat + wt +  qsec)
fm8 <- update(fit, mpg ~ cyl + disp + hp + drat + wt +  qsec + vs)
fm9 <- update(fit, mpg ~ cyl + disp + hp + drat + wt +  qsec + vs + gear)
fm10 <- update(fit, mpg ~ cyl + disp + hp + drat + wt +  qsec + vs + gear + carb)
anova(fit, fm2, fm3, fm4, fm5, fm6, fm7, fm8, fm9, fm10)
vif(fm6)
sqrt(vif(fm6))
confint(fm6)
```


##      Best Fit Modeling 
Based on the nested modeling process followed by the anova table check then followed by the vif and sqrt(vif) test we decide to go with the following model labeled (fbf1) and notice that all of the sqrt(vif) values are less than 2.0 indicating a good model fit.
```{r Fig.8_BestFitModeling, eval=FALSE, fig.height=5, fig.width=5, message=TRUE, warning=TRUE, include=FALSE, results='hide'}
library(car)
data("mtcars")
fbf1 <- lm(mpg ~ cyl + disp + wt + am, data = mtcars)
vif(fbf1)
sqrt(vif(fbf1))
library(ggplot2);library(graphics)
x <- (mtcars$cyl + mtcars$disp + mtcars$wt + mtcars$am)
par(mfrow = c(1,1), mar = c(4,4,2,2)) # set margin
g <- ggplot(mtcars, aes(x = x, y = mpg),)
g <- g + xlab("hp + drat + am")
g <- g + ylab("Miles per Gallon")
g <- g + geom_point(size = 3, col = "blue", alpha = 0.55)
g <- g + geom_smooth(method = "lm", col = "black")
g
```


#       DIAGNOSTICS A
```{r Fig.9_ResidFit, eval=FALSE, fig.height=4.5, fig.width=4.5, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
y <- mtcars$mpg
x <- (mtcars$cyl + mtcars$disp + mtcars$wt + as.numeric(mtcars$am))
n <- length(y)
fw <- lm(y ~ x, data = ordmtcars)
coef(summary(fw))
e <- resid(fw)# ;e;plot(e);sum(e)
plot(x,e,
     xlab = "cyl + disp + wt + am",
     ylab = "Residuals (MPG)",
     bg = "lightblue",
     col = "black", cex = 1.5, pch = 21, frame = FALSE)
abline(h = 0, lwd = 2)
for(i in 1:n)
        lines(c(x[i], x[i]), c(e[i], 0), col = "red", lwd = 2)
```


```{r hatvalues, eval=FALSE, fig.height=4.5, fig.width=4.5, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
hv1 <- hatvalues(lm(mpg ~ ., data = ordmtcars));hv1;plot(hv1)
```

```{r dft2, eval=FALSE, fig.height=4.5, fig.width=4.5, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
f2 <- lm(mpg ~ ., data = ordmtcars)
dft2 <- dffits(f2);dft2;plot(dft2)
```

```{r cooksDist, eval=FALSE, fig.height=4.5, fig.width=4.5, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
cd1 <- cooks.distance(lm(mpg ~ ., data = ordmtcars));cd1;plot(cd1)
```

```{r resid(fit)/(1-hatvalues(fit)), eval=FALSE, fig.height=4.5, fig.width=4.5, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
f2 <- lm(mpg ~ ., data = ordmtcars)
pressResid1 <- resid(f2)/(1-hatvalues(f2));pressResid1;plot(pressResid1)
```


#       DIAGNOSTICS B
```{r Fig.10_dfbetaPlots, eval=FALSE, fig.height=3.5, fig.width=3.5, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
dfbetaplots(lm(mpg ~ cyl + disp + hp + wt + am, data = ordmtcars, family = binomial))
par(mfrow = c(4, 4), mar = c(4.0, 3.0, 3.0, 3.0))
```


# however the confint for drat, hp and wt each include zero
```{r ConfInt, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
fbf3 <- lm(mpg ~ hp + drat + factor(am) , data = mtcars)
coef(summary(fbf3))
confint(fbf3)
```

############### NEXT PROCESS: Prediction !!!! #################
```{r Prediction, eval=FALSE, warning=TRUE, include=FALSE}

```

#       Preliminary Findings:  
        Questions of Interest:
                A What other regressors if any correlated with mpg rating and transmission type?
                B 
        Interpretation of Results:
                A Using ANOVA table with Nested Multivariate Regression fit it is clear that the variable weight (wt) is significance according with a code of ** = 0.001
                B Based on the 
                C

#       Inference:
        Hypothesis':
                A H0 = The difference between Automatic and Manual transmission MPG = 0   
                B Ha = The difference between Automatic and Manual transmission MPG != 0
                C Desired confidence interval = .95 (one sided) ??

#       Conclusions / Recommendations:  
        A
        B

#       Are there other alternative analyses?
        A VIF
        B Challenge the results ?
        C Measures of uncertainty 'e'

---
#       Appendix A: "Exploratory Graphical Analysis"

##      Pairs Plot: 
#### Interpretation: MPG decreases as the; # of cylinders increases, the engine displacement increases, the horsepower increases, the weight increases, the rear axle ratio decreases, qsec time decreases, the engine is a V-block, # of gears decreases, and the # of carburators increases ~ conversely the MPG increases as the: rear axle ratio increases, qsec time increases, the engine is a Straight-block, transmission is manual, # of gears increases and the # of carburators decreases
```{r Fig.1_Pairs, echo=FALSE, fig.height=6, fig.width=7.5, message=FALSE, warning=FALSE}
# ppplot <- pairs(ordmtcars, main = "mtcars data")
coplot(mpg ~ hp + drat | as.factor(cyl) + as.factor(am), data = mtcars,
       panel = panel.smooth, rows = 1)
```

##      Histograms Plot
```{r Fig.2_Hist, echo=FALSE, fig.height=4.0, fig.width=6.5}
data(mtcars)
par(mfrow = c(2,1), mar = c(4,4,4,4)) # set margin
mtcars$vs <- factor(mtcars$vs, labels = c("V-block", "S-block")); mtcars$am <- factor(mtcars$am, labels = c("Auto", "Manual")); mtcars$gear <- factor(mtcars$gear); mtcars$carb <- factor(mtcars$carb)
head(mtcars,3)
hist(mtcars$mpg[mtcars$am=="Auto"], breaks=10, xlab = "Miles-Per-gallon", ylab = "Frequency", main = "Automatic Transmission", col = "yellow", xlim = range(5:40))
abline(v=mean(mtcars$mpg[mtcars$am=="Auto"]), col="red", lwd = 4)
hist(mtcars$mpg[mtcars$am=="Manual"], breaks=10, xlab = "Miles-Per-gallon", ylab = "Frequency", main = "Manual Transmission", col="lightblue", xlim = range(5:40))
abline(v=mean(mtcars$mpg[mtcars$am=="Manual"]), col="blue", lwd = 4)
```

##      Box Plot
```{r Fig.3_BoxPlot, echo=FALSE, fig.height=4, fig.width=6.5}
data("mtcars");par(mfrow = c(1,1), mar = c(4,4,4,4))
mtcars$vs <- factor(mtcars$vs, labels = c("V-block", "S-block")); mtcars$am <- factor(mtcars$am, labels = c("Auto", "Manual")); mtcars$gear <- factor(mtcars$gear); mtcars$carb <- factor(mtcars$carb)
head(mtcars,3)
boxplot(mpg ~ am, data = mtcars, col = (c("yellow","lightblue")), ylab = "Miles-Per-Gallon", xlab = "Transmission", main =  "Automatic vs Manual Transmission, Miles Per Gallon Ratings")
```

##      NOTE: use the cut function by 3 on MPG

===
        END
===

