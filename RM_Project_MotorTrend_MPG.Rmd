---
title: "Regression Models Project - Motor Trend Data 'mtcars' Miles Per Gallon Analysis"
author: "james c walmsley"
date: "12/1/2016"
output:
  html_document: default
  pdf_document:
    fig_caption: yes
    fig_height: 5.5
---

#       Executive Summary:    
        The mean "MPG" rating of vehicles with automatic transmisions is  
        17.15 mpg, and those with manual transmisions 24.38 mpg for a  
        difference of 7.24 mpg in favor of the manual transmission in the given  
        data set.
        
        Upon further analysis of the relationship between vehicle design  
        components and "MPG" ratings in this particular dat set we find that a  
        small number of vehicles exhibit a degree of leverage and influence  
        over the "MPG" analysis results at both ends of the ratings. The  
        following vehicles!!!!!!!
        
        
        Additionally, vehicle weight is highly correlated (-86.77%) with mpg  
        ratings in the ordered datas set and transmission type is highly  
        correlated with vehicle wieght at (69%). In other words lighter vehicles  
        tend to have manual transmissions where as heavier vehicles tend to have  
        automatic trasnmissions. Figure XXX shows the analysis that explains  
        this bias in the data and is confirmed in the QQ plots where the low and  
        high "MPG" ratings are not inclusive of both types of transmissions.  
        This figure also shows that where the cubic inch displacement and hp are  
        generally equivalent between transmission types there is only a very  
        slight difference in "MPG" rating. 
        
        To answer the question of whether automatic or manual transmissions are  
        better for gas mileage we will look at vehicles with roughly the same  
        design components as possible using this given data set.  Such a  
        comparison is best shown in figure XXXXX
        
        
#       Problem Statement & Questions:    
                ## Q1 “Is an automatic or manual transmission better for 'mpg'”  
                ## Q2 "Quantify the MPG difference between automatic and manual  
                transmissions"  
---

#       Grading - Criteria (remove on completion)!!!  
        ####YES!!!! Did the report include an executive summary?
        ####???? Did the student answer the questions of interest or detail why  
        the question(s) is (are) not answerable?
        ####???? Did the student quantify the uncertainty in their conclusions  
        and/or perform an inference correctly?
        ####???? Was the report brief (about 2 pages long) for the main body of  
        the report and no longer than 5 with supporting appendix of figures?


        ####YES!!!! Did the student interpret the coefficients correctly?
        ####YES!!!! Did the student do some exploratory data analyses?


        ####YES!!!! Did the student fit multiple models and detail their  
        strategy for model selection?
        ####Needs some more work


        ####YES!!!! Did the student do a residual plot and some diagnostics?
        ####YES!!!! Was the report done in Rmd (knitr) with pdf output?

---

#       Analysis Considerations:  
        Descriptive - (dim, mean, sd, sigma^2, str & summary) statistics
        
        Exploratory - pairs, histograms, QQ, fitted, residualplots, boxplots  
        & (multiple plots); T-Test
        
        Analysis -  OLS, simple linear regression, statistical linear  
        regression, multivariate regression & model selection, logistic  
        regression, pValues, adjustments, residuals, residual fit, predict fit,  
        hatvalues, variance, & dfbetas, R^2, diagnostics; ANOVA, coeficients,  
        confint, correlation, covariance, variance inflation

#       Software Environment:    
System - session Info: Set the Working Directory then get System & Session Info
```{r SetDirectory, echo=TRUE, eval=FALSE, include=FALSE, results='hide'}
setwd("~/Desktop/Coursera_R/7_Regression Models/RM_proj_MPG_MotorTrendData")
sessionInfo()
```        
       
#       Access Data:  
Clean the work space, import the data from thr R data sets package and check for
any missing values.

Raw Data Overview: Motor Trend 'mtcars' data set: 
```{r Data_mtcars, echo=TRUE, cache=TRUE, include=FALSE, results='hide'}
rm(list=ls());library(car);library(dplyr);library(xtable);data("mtcars");any(is.na(mtcars))
```
A data frame with 32 observations on 11 variables.  

[, 1]	mpg	Miles/(US) gallon    
[, 2]	cyl	Number of cylinders (4,6,8)  
[, 3]	disp	Displacement (cu.in.)    
[, 4]	hp	Gross horsepower    
[, 5]	drat	Rear axle ratio    
[, 6]	wt	Weight (1000 lbs)    
[, 7]	qsec	1/4 mile time    
[, 8]	vs	V/S (V = vee-block, S = straight-block)  
[, 9]	am	Transmission (0 = automatic, 1 = manual)    
[,10]	gear	Number of forward gears (3,4,5)  
[,11]	carb	Number of carburetors (1,2,3,4,6,8)  

#       Process Data:  
Factor columns 2 & 8:11 (cyl,vs,am,gear,carb) and order the data on mpg from  
the lowest to highest mpg rating
```{r ProcessData_factor, echo=TRUE, eval=FALSE, cache=TRUE, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
data("mtcars");for(i in c(2,8:11))mtcars[,i] <- as.factor(mtcars[,i]);str(mtcars)
```

#       Descriptive Statistics:  
Reveiw data set for obvious visual patterns or trends using descriptive  
statistics r code to generate a data overview using functions str & summary and  
the following graphics: pairs plots, histograms and boxplots and save them to
Appendix A, Figures for Exploratory Analysis
```{r Descriptive_Stats, echo=TRUE, eval=TRUE, include=FALSE, results='hide'}
mean(mtcars$mpg);ordmtcars <<- mtcars[order(mtcars$mpg,decreasing = FALSE),]
str(ordmtcars);summary(ordmtcars);ordmtcars[27:32,]
```


#       Exploratory Analysis:    
Develop r code to analyze and identify any significant relationships /  
correlations between mpg ratings and transmission type and or any of the other    
ten varialbes for observations contained in the data set. Use avaialbe   
regression model tools to find the best model fit, examine the coefficients,    
hatvalues, residuals, dfbetas, variance inflation, and R^2 values to spot over    
or underfitting of the model.  



#############

```{r ExpAna1, echo=TRUE, eval=TRUE, include=FALSE, results='hide'}
library(kernlab)
set.seed(8932)
trainIndicator = rbinom(32, size = 1, prob = 0.5)
table(trainIndicator)
```


#############





#       Statistical Modeling:  
### Regression & Model Fit:    
        ## Assumptions:    
                ## A     
                ## B    

#       Simple Linear Regression Plot:
Examine the relationship between mpg ratings and transmission type; automatic vs manual
```{r Fig.4_SimpleLR, echo=FALSE, eval=FALSE, fig.align='center',fig.height=4.0, fig.width=6.5, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
ordmtcars$am <- factor(ordmtcars$am, labels = c("Auto", "Manual"))
f1 <- lm(mpg ~ am, data = ordmtcars)
coef(summary(f1))
par(mfrow = c(1,1), mar = c(2,2,2,2)) # set margin
g <- ggplot(ordmtcars, aes(x = factor(am), y = mpg),)
g <- g + xlab("Transmission Type")
g <- g + ylab("Miles per Gallon")
g <- g + geom_point(size = 4.0, col = "blue", alpha = .45)
g <- g + geom_abline(intercept = 9.91, slope = 7.24) # adjusted (-7.24) to fit grid
g
```


#       Bivariate Linear Model:  
Examine the relationship between mpg & two variables: am & weight beacuse weight has an -86%  
negative correlation with mpg (the highest single variable correlation with mpg)
```{r Fig.5_BivariateLM_1, echo=FALSE, eval=FALSE, fig.align='center', fig.height=6.0, fig.width=7.5, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
library(car)
f2 <- lm(mpg ~ as.numeric(am) + wt, data = ordmtcars)
hatvalues(f2);coef(summary(f2));vif(f2);sqrt(vif(f2))
par(mfrow = c(2,2), mar = c(4,4,3,2)) # set margin
plot(f2)
```

```{r Fig.5_BivariateLM_2, echo=FALSE, eval=FALSE, fig.align='center', fig.height=4, fig.width=7, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
library(car)
f2 <- lm(mpg ~ as.numeric(am) + wt, data = ordmtcars)
par(mfrow = c(1,1), mar = c(4,4,4,2))
g <- ggplot(mtcars, aes(x = as.numeric(am) + wt , y = mpg),)
g <- g + xlab("Transmission Type + Weight")
g <- g + ylab("Miles per Gallon")
g <- g + geom_smooth(aes(method = "lm", se = FALSE))
g <- g + geom_point(size = 3.5, col = "blue", alpha = .65)
g
```

#       Multivariate Linear Model (all vars):

The influence measures test indicates that the following vehicles exhibit  
substatial influence on the model fit; "Merc 230","Merc 280", "Honda Civic",  
"Camaro Z28","Porsche 914-2","ford Pantera L","ferrari Dino","Maserati Bora"
based on the cov.r (covariance ratio) at 2.809 or above


```{r Fig.6_MVLM(allvars), echo=FALSE, eval=c(1,2,4,7:19), fig.align='center', fig.height=7, fig.width=9, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
library(car);library(ggplot2)
data("mtcars")
as.numeric(unlist(mtcars))
f3 <- lm(mpg ~ ., data = mtcars)
coef(summary(f3))
vif(f3)
sqrt(vif(f3))
par(mfrow = c(1, 1), mar = c(3,3,3,2))
g <- ggplot(mtcars, aes(x = (cyl + disp + hp + drat + wt + qsec + vs + am + gear + carb), y = mpg),)
g <- g + xlab("All Design Components Inclusive")
g <- g + ylab("Miles per Gallon")
g <- g + geom_smooth(aes(method = "lm", se = FALSE))
g <- g + geom_point(aes(shape = factor(am), size = 4.0))
g <- g + geom_point(aes(colour = factor(cyl)))
g
```

#       Multivariate Linear Model (all vars) Adjusted:
```{r Fig.7_MVLM(allvars)A, echo=FALSE,  eval=c(1,2,5:12), fig.align='center', fig.height=7,fig.width=9, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
library(car);library(ggplot2)
f6 <- lm(mpg ~ . -1, data = ordmtcars)
coef(summary(f6))
confint(f6)
par(mfrow = c(1,1), mar = c(4,4,2,2)) # set margin
g <- ggplot(mtcars, aes(x = cyl, disp, hp, drat, wt, qsec, vs, am, gear, carb, am, -1, y = mpg),)
g <- g + xlab("Multivariate(allvars)- Adjusted to Intercept")
g <- g + ylab("Miles per Gallon")
g <- g + geom_smooth(aes(method = "lm", se = FALSE))
g <- g + geom_point(aes(shape = factor(am), size = 4.0))
g <- g + geom_point(aes(colour = factor(cyl)))
g
```



#       Multivariate Linear Model (all vars - am):

Remove the am variable from the multivariate linear regression to see what  
effect it has on the fit

```{r Fig.7_MVLM(allvars -(am)), echo=TRUE, eval=TRUE, fig.height=4, fig.width=4, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
data("mtcars");as.numeric(unlist(mtcars))
f4 <- lm(mpg ~ . - am, data = mtcars)
coef(summary(f4));vif(f4);sqrt(vif(f4));# plot(f3)
par(mfrow = c(1, 1), mar = c(4,4,4,2))
g <- ggplot(mtcars, aes(x = (cyl + disp + hp + drat + wt + qsec + vs + gear + carb), y = mpg),)
g <- g + xlab("All Design Components - am")
g <- g + ylab("Miles per Gallon")
g <- g + geom_smooth(aes(method = "lm", se = FALSE))
g <- g + geom_point(size = 2.5, col = "black", alpha = .85)
g <- g + geom_point(aes(shape = factor(gear), size = 4.5, colour = "white"))
g <- g + geom_point(aes(colour = factor(cyl), size = 3.5))
g <- g + geom_point(aes(size = drat), alpha = .4)
g
# par(mfrow = c(2, 2), mar = c(4,4,4,2))
# plot(f4)
```



Finding a better model fit; use the variables with low sqrt of variance  
inflation =  cyl, drat, vs, am, gear & carb; The following multivariate model
includes these regressors

```{r, eval=FALSE, fig.height=3, fig.width=3, message=FALSE, warning=FALSE, include=FALSE}
library(ggplot2);library(dplyr);data("mtcars")
f4 <- lm(mpg ~ am + drat +  cyl + vs + gear + carb, data = mtcars)
f5 <- lm(mpg ~ I(am + drat) + carb, data = mtcars)
sqrt(vif(f5))
x <- mtcars[,c(5,9,11)]
y <- mtcars$mpg
n <- length(y)
par(mfrow = c(2,1), mar = c(4,4,2,2)) # set margin
g <- ggplot(mtcars, aes(x = drat, am, carb, y = y),)
g <- g + xlab("(am + drat) + carb")
g <- g + ylab("Miles per g1allon")
g <- g + geom_smooth(aes(method = "lm", se = FALSE))
g <- g + geom_point(size = 3.0, col = "black", alpha = .65)
g
```


#       Multivariate LM Nested & ANOVA table:
Second approach to finding a better model fit

With nested modeling method, models 3 & 6 each add a significate variable to the  
fitted model and in this case model 3 is disp & model 6 is wt. Now use the vif  
(variable inflation) test on model six to check for any variance inflation among  
the varialbes of this model. The results show that "hp", "drat", and "wt" all  
have square rooted infaltion values less than 3.0 so these can be accepted into  
the model of best fit (fbf1) along with the main variable of the study "am"

```{r MVLM_ANOVA_table, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
library(car)
f7 <- lm(mpg ~ factor(am), data = ordmtcars)
fm2 <- update(f7, mpg ~ cyl)
fm3 <- update(f7, mpg ~ cyl + disp)
fm4 <- update(f7, mpg ~ cyl + disp + hp)
fm5 <- update(f7, mpg ~ cyl + disp + hp + drat)
fm6 <- update(f7, mpg ~ cyl + disp + hp + drat + wt)
fm7 <- update(f7, mpg ~ cyl + disp + hp + drat + wt +  qsec)
fm8 <- update(f7, mpg ~ cyl + disp + hp + drat + wt +  qsec + vs)
fm9 <- update(f7, mpg ~ cyl + disp + hp + drat + wt +  qsec + vs + gear)
fm10 <- update(f7, mpg ~ cyl + disp + hp + drat + wt +  qsec + vs + gear + carb)
anova(f7, fm2, fm3, fm4, fm5, fm6, fm7, fm8, fm9, fm10)
vif(fm6)
sqrt(vif(fm6))
confint(fm6)
```


#       Modeling Best Fit:
Based on the nested modeling process followed by the anova table check then  
followed by the vif and sqrt(vif) test we decide to go with the following model  
labeled (fbf1) and notice that all of the sqrt(vif) values are less than 1.6  
indicating most likely a good fit.
```{r Fig.8_BestFitModeling, eval=FALSE, fig.height=5, fig.width=5, message=TRUE, warning=TRUE, include=FALSE, results='hide'}
library(car)
data("mtcars")
f8 <- lm(mpg ~ cyl + wt + am, data = mtcars)
vif(f8)
sqrt(vif(f8))
library(ggplot2);library(graphics)
x <- (mtcars$cyl + mtcars$wt + mtcars$am)
par(mfrow = c(1,1), mar = c(4,4,2,2)) # set margin
g <- ggplot(mtcars, aes(x = x, y = mpg),)
g <- g + xlab("(cyl + wt + am)")
g <- g + ylab("Miles per Gallon")
g <- g + geom_smooth(aes(method = "lm", se = FALSE))
g <- g + geom_point(aes(shape = factor(am), size = 4.0, alpha = .2))
g
```


###############--------------#################------------------#####################


==================


#       DIAGNOSTICS A
Resid fit plot produces a random distribution in three distinct groups indicating 
the number of cylinders that were included in this particular model fit as factors
```{r Fig.9_ResidFit, eval=FALSE, fig.height=4.5, fig.width=4.5, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
ordmtcars$am <- factor(ordmtcars$am, labels = c("Auto", "Manual"))
y <- mtcars$mpg
x <- (mtcars$cyl + mtcars$wt + as.numeric(mtcars$am))
n <- length(y)
fw <- lm(y ~ x, data = ordmtcars)
coef(summary(fw))
e <- resid(fw)# ;e;plot(e);sum(e)
plot(x,e,
     xlab = "cyl + wt + am",
     ylab = "Residuals (MPG)",
     bg = "lightblue",
     col = "black", cex = 1.5, pch = 21, frame = FALSE)
abline(h = 0, lwd = 2)
for(i in 1:n)
        lines(c(x[i], x[i]), c(e[i], 0), col = "red", lwd = 2)
```

The hatvalues plot does not exhibit any obvious patterns or trends
```{r hatvalues, eval=FALSE, fig.height=4.5, fig.width=4.5, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
ordmtcars$am <- factor(ordmtcars$am, labels = c("Auto", "Manual"))
y <- mtcars$mpg
x <- (mtcars$cyl + mtcars$wt + as.numeric(mtcars$am))
n <- length(y)
hv1 <- hatvalues(lm(mpg ~ x, data = ordmtcars));hv1;plot(hv1)
```


The dffits test shows evenly distributed random results above and
below the center at zero with a single outlier at 6 with a 31 mmpg rating
```{r dft2, eval=FALSE, fig.height=4.5, fig.width=4.5, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
ordmtcars$am <- factor(ordmtcars$am, labels = c("Auto", "Manual"))
y <- mtcars$mpg
x <- (mtcars$cyl + mtcars$wt + as.numeric(mtcars$am))
n <- length(y)
f2 <- lm(mpg ~ x, data = ordmtcars)
dft2 <- dffits(f2)
plot(dft2)
```



```{r cooksDist, eval=FALSE, fig.height=4.5, fig.width=4.5, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
ordmtcars$am <- factor(ordmtcars$am, labels = c("Auto", "Manual"))
y <- mtcars$mpg
x <- (mtcars$cyl + mtcars$wt + as.numeric(mtcars$am))
n <- length(y)
cd1 <- cooks.distance(lm(mpg ~ x, data = ordmtcars))
plot(cd1)
```





```{r resid(fit)/(1-hatvalues(fit)), eval=FALSE, fig.height=4.5, fig.width=4.5, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
ordmtcars$am <- factor(ordmtcars$am, labels = c("Auto", "Manual"))
y <- mtcars$mpg
x <- (mtcars$cyl + mtcars$wt + as.numeric(mtcars$am))
n <- length(y)
f2 <- lm(mpg ~ x, data = ordmtcars)
pressResid1 <- resid(f2)/(1-hatvalues(f2));pressResid1;plot(pressResid1)
```


#       DIAGNOSTICS B
```{r Fig.10_dfbetaPlots, eval=FALSE, fig.height=3.5, fig.width=3.5, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
ordmtcars$am <- factor(ordmtcars$am, labels = c("Auto", "Manual"))
y <- mtcars$mpg
x <- (mtcars$cyl + mtcars$wt + as.numeric(mtcars$am))
n <- length(y)
plot(dfbeta(lm(mpg ~ x, data = ordmtcars, family = binomial)))
# par(mfrow = c(4, 4), mar = c(4.0, 3.0, 3.0, 3.0))
```


```{r ConfInt, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
ordmtcars$am <- factor(ordmtcars$am, labels = c("Auto", "Manual"))
y <- mtcars$mpg
x <- (mtcars$cyl + mtcars$wt + as.numeric(mtcars$am))
n <- length(y)
fbf3 <- lm(mpg ~ x, data = mtcars)
coef(summary(fbf3))
confint(fbf3)
```

############----------------#################------------------####################

```{r Prediction, eval=FALSE, warning=TRUE, include=FALSE}

```




#       Preliminary Findings:  
        Questions of Interest:
                A What other regressors if any correlated with mpg rating and 
                transmission type?
                B 
        Interpretation of Results:
                A Using ANOVA table with Nested Multivariate Regression fit it  
                is clear that the variable weight (wt) is significance according  
                with a code of ** = 0.001
                B Based on the 
                C

#       Inference:
        Hypothesis':
                A H0 = The difference between Automatic and Manual transmission  
                MPG = 0   
                B Ha = The difference between Automatic and Manual transmission  
                MPG != 0
                C Desired confidence interval = .95 (one sided) ??

#       Conclusions / Recommendations:  
        A
        B

#       Any alternative analyses?
        A VIF
        B Challenge the results ?
        C Measures of uncertainty 'e'

---
#       Appendix A: Figures for the "Exploratory Analysis"

##      Pairs Plot: 
Interpretation: MPG decreases as the; # of cylinders increases, the engine  
displacement increases, the horsepower increases, the weight increases, the rear  
axle ratio decreases, qsec time decreases, the engine is a V-block, # of gears  
decreases, and the # of carburators increases ~ conversely the MPG increases as  
the: rear axle ratio increases, qsec time increases, the engine is a  
Straight-block, transmission is manual, # of gears increases and the # of  
carburators decreases


```{r Fig.1_Pairs, echo=FALSE, fig.align='center', fig.height=5, fig.width=6.5, message=FALSE, warning=FALSE}
# ppplot <- pairs(ordmtcars, main = "mtcars data")
coplot(mpg ~ as.numeric(carb) + drat | as.factor(cyl) +  as.factor(am), data = mtcars,
       panel = panel.smooth, rows = 1)
```

##      Histogram:
```{r Fig.2_Hist, echo=FALSE, fig.align='center', fig.height=4.0, fig.width=6.5}
data(mtcars)
par(mfrow = c(2,1), mar = c(4,4,4,4)) # set margin
mtcars$vs <- factor(mtcars$vs, labels = c("V-block", "S-block")); mtcars$am <- factor(mtcars$am, labels = c("Auto", "Manual")); mtcars$gear <- factor(mtcars$gear); mtcars$carb <- factor(mtcars$carb)
hist(mtcars$mpg[mtcars$am=="Auto"], breaks=10, xlab = "Miles-Per-gallon", ylab = "Frequency", main = "Automatic Transmission", col = "yellow", xlim = range(5:40))
abline(v=mean(mtcars$mpg[mtcars$am=="Auto"]), col="red", lwd = 4)
hist(mtcars$mpg[mtcars$am=="Manual"], breaks=10, xlab = "Miles-Per-gallon", ylab = "Frequency", main = "Manual Transmission", col="lightblue", xlim = range(5:40))
abline(v=mean(mtcars$mpg[mtcars$am=="Manual"]), col="blue", lwd = 4)
```

##      Box Plot:
```{r Fig.3_BoxPlot, echo=FALSE, fig.align='center', fig.height=4, fig.width=6.5}
data("mtcars");par(mfrow = c(1,1), mar = c(4,4,4,4))
mtcars$vs <- factor(mtcars$vs, labels = c("V-block", "S-block")); mtcars$am <- factor(mtcars$am, labels = c("Auto", "Manual")); mtcars$gear <- factor(mtcars$gear); mtcars$carb <- factor(mtcars$carb)
boxplot(mpg ~ am, data = mtcars, col = (c("yellow","lightblue")), ylab = "Miles-Per-Gallon", xlab = "Transmission", main =  "Automatic vs Manual Transmission, Miles Per Gallon Ratings")
```


===
        END
===

